---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BottomCTA from '../../components/BottomCTA.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

const posts = allPosts.toSorted(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });

---

<BaseLayout
  title="Blog | Epic Itineraries"
  description="Thoughts on travel research, product building, and the stories behind Epic Itineraries."
>
  <Header transparent={false} />

  <main class="pt-24">
    <!-- Page header -->
    <section class="py-16 md:py-20">
      <div class="container max-w-5xl">
        <h1 class="font-serif text-4xl font-normal italic text-primary mb-4 md:text-5xl animate-on-scroll">
          Blog
        </h1>
        <p class="text-lg text-muted-foreground max-w-2xl animate-on-scroll">
          Thoughts on travel research, product building, and the stories behind
          Epic Itineraries.
        </p>
      </div>
    </section>

    <!-- Posts grid -->
    <section class="pb-16 md:pb-24">
      <div class="container max-w-5xl">
        {posts.length === 0 ? (
          <div class="text-center py-20 animate-on-scroll">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mx-auto text-muted-foreground/40 mb-6"
            >
              <path d="M12 20h9"></path>
              <path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"></path>
            </svg>
            <p class="text-muted-foreground text-lg">
              Posts are on their way. Check back soon.
            </p>
          </div>
        ) : (
          <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3 stagger-children">
            {posts.map((post) => (
              <a
                href={`/blog/${post.id}`}
                class="group block overflow-hidden rounded-2xl bg-card shadow-sm transition-all duration-300 hover:shadow-md hover:-translate-y-1 animate-on-scroll"
              >
                {/* Hero image or gradient placeholder */}
                <div class="relative aspect-[16/10] overflow-hidden">
                  {post.data.heroImage ? (
                    <img
                      src={post.data.heroImage}
                      alt={post.data.title}
                      class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy"
                    />
                  ) : (
                    <div class="h-full w-full bg-gradient-to-br from-brand-cream-dark via-brand-coral/10 to-brand-green/10">
                      <div
                        class="absolute inset-0 opacity-[0.04]"
                        style="background-image: radial-gradient(circle, oklch(0.35 0.06 160) 1px, transparent 1px); background-size: 20px 20px;"
                      />
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="32"
                        height="32"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="absolute bottom-4 right-4 text-brand-coral/25"
                      >
                        <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>
                      </svg>
                    </div>
                  )}
                  {/* Draft badge */}
                  {post.data.draft && (
                    <span class="absolute top-3 left-3 rounded-full bg-brand-coral/90 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wider text-white">
                      Draft
                    </span>
                  )}
                </div>

                {/* Content */}
                <div class="p-5 md:p-6">
                  {/* Tags */}
                  {post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-1.5 mb-3">
                      {post.data.tags.slice(0, 3).map((tag) => (
                        <span class="inline-flex items-center rounded-full bg-brand-cream-dark px-2.5 py-0.5 text-[11px] font-medium text-muted-foreground">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}

                  <h2 class="font-serif text-xl font-normal italic text-primary leading-snug mb-2 transition-colors group-hover:text-brand-green-light">
                    {post.data.title}
                  </h2>

                  <p class="text-sm text-muted-foreground leading-relaxed mb-4 line-clamp-2">
                    {post.data.description}
                  </p>

                  <time
                    datetime={post.data.publishDate.toISOString()}
                    class="text-xs text-muted-foreground/70"
                  >
                    {formatDate(post.data.publishDate)}
                  </time>
                </div>
              </a>
            ))}
          </div>
        )}
      </div>
    </section>

    <!-- Bottom CTA -->
    <BottomCTA />
  </main>

  <Footer />
</BaseLayout>
